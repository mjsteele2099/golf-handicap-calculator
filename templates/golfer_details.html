<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ golfer.name }} - Golf Handicap Calculator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px auto;
            padding: 30px;
            max-width: 1000px;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.2s ease;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        .handicap-display {
            font-size: 3rem;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            padding: 30px;
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            margin: 20px 0;
        }
        .score-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
            transition: transform 0.2s ease;
        }
        .score-item:hover {
            transform: translateX(5px);
            background: #e9ecef;
        }
        .stats-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }
        .stats-card h3 {
            font-size: 2.5rem;
            margin-bottom: 5px;
        }
        .back-btn {
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 10px;
            padding: 8px 16px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .back-btn:hover {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="display-5 text-primary mb-1">
                        <i class="bi bi-person-circle"></i> {{ golfer.name }}
                    </h1>
                    <p class="text-muted">Golfer Details & Score History</p>
                </div>
                <a href="/" class="back-btn">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
            </div>

            <!-- Stats Row -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="stats-card">
                        <h3>{{ handicap_index if handicap_index is not none else "N/A" }}</h3>
                        <p class="mb-0">Handicap Index</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stats-card">
                        <h3>{{ scores|length }}</h3>
                        <p class="mb-0">Total Scores</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stats-card">
                        <h3>{% if scores %}{{ scores[0].differential|round(1) }}{% else %}N/A{% endif %}</h3>
                        <p class="mb-0">Best Differential</p>
                    </div>
                </div>
            </div>

            <!-- Handicap Status -->
            {% if handicap_index is none %}
            <div class="alert alert-warning text-center" style="border-radius: 15px;">
                <h5><i class="bi bi-exclamation-triangle"></i> Handicap Not Established</h5>
                <p class="mb-0">Need {{ 3 - scores|length }} more score(s) to establish a handicap index.</p>
            </div>
            {% endif %}

            <!-- Add New Score Form -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-plus-circle"></i> Add New Score</h5>
                </div>
                <div class="card-body">
                    <form id="newScoreForm">
                        <div class="row">
                            <div class="col-md-4">
                                <!-- Course Entry Method Toggle -->
                                <div class="mb-3">
                                    <label class="form-label">Course Entry Method</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="newCourseMethod" id="newExistingCourse" checked>
                                        <label class="btn btn-outline-primary" for="newExistingCourse">Select Course</label>
                                        
                                        <input type="radio" class="btn-check" name="newCourseMethod" id="newManualCourse">
                                        <label class="btn btn-outline-primary" for="newManualCourse">Manual Entry</label>
                                    </div>
                                </div>

                                <!-- Existing Course Selection -->
                                <div id="newExistingCourseSection" class="mb-3">
                                    <label class="form-label">Course</label>
                                    <select class="form-control" id="newScoreCourse">
                                        <option value="">Select Course</option>
                                    </select>
                                </div>

                                <!-- Manual Course Entry -->
                                <div id="newManualCourseSection" style="display: none;">
                                    <div class="mb-3">
                                        <label class="form-label">Course Name</label>
                                        <input type="text" class="form-control" id="newManualCourseName" placeholder="Enter course name">
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Par</label>
                                                <input type="number" class="form-control" id="newManualPar" value="72" min="60" max="80">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Slope</label>
                                                <input type="number" class="form-control" id="newManualSlopeRating" value="113" min="55" max="155">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Course Rating</label>
                                        <input type="number" class="form-control" id="newManualCourseRating" step="0.1" min="50" max="80" placeholder="e.g. 72.3">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Gross Score</label>
                                    <input type="number" class="form-control" id="newGrossScore" min="40" max="150" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Date Played</label>
                                    <input type="date" class="form-control" id="newDatePlayed" required>
                                </div>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100 mb-3">
                                    <i class="bi bi-save"></i> Add Score
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Scores History -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-list-ol"></i> Score History</h5>
                </div>
                <div class="card-body">
                    {% if scores %}
                        {% for score in scores %}
                        <div class="score-item" id="score-{{ score.id }}">
                            <!-- Display Mode -->
                            <div class="score-display">
                                <div class="row">
                                    <div class="col-md-4">
                                        <h6 class="mb-1">{{ score.course_name }}</h6>
                                        <small class="text-muted">{{ score.date_played.strftime('%B %d, %Y') }}</small>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <div class="fw-bold" style="font-size: 1.2rem;">{{ score.gross_score }}</div>
                                        <small class="text-muted">Gross Score</small>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <div class="fw-bold" style="font-size: 1.2rem;">{{ "%.1f"|format(score.differential) }}</div>
                                        <small class="text-muted">Differential</small>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="d-flex justify-content-end gap-2">
                                            <button class="btn btn-outline-primary btn-sm" onclick="editScore({{ score.id }})">
                                                <i class="bi bi-pencil"></i> Edit
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" onclick="deleteScore({{ score.id }})">
                                                <i class="bi bi-trash"></i> Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Edit Mode (initially hidden) -->
                            <div class="score-edit" style="display: none;">
                                <form class="edit-score-form" data-score-id="{{ score.id }}">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <!-- Course Entry Method Toggle -->
                                            <div class="mb-3">
                                                <label class="form-label">Course Entry Method</label>
                                                <div class="btn-group w-100" role="group">
                                                    <input type="radio" class="btn-check" name="editCourseMethod{{ score.id }}" id="editExistingCourse{{ score.id }}" checked>
                                                    <label class="btn btn-outline-primary" for="editExistingCourse{{ score.id }}">Select Course</label>
                                                    
                                                    <input type="radio" class="btn-check" name="editCourseMethod{{ score.id }}" id="editManualCourse{{ score.id }}">
                                                    <label class="btn btn-outline-primary" for="editManualCourse{{ score.id }}">Manual Entry</label>
                                                </div>
                                            </div>

                                            <!-- Existing Course Selection -->
                                            <div id="editExistingCourseSection{{ score.id }}" class="mb-3">
                                                <label class="form-label">Course</label>
                                                <select class="form-control edit-course-select" id="editScoreCourse{{ score.id }}">
                                                    <option value="">Select Course</option>
                                                </select>
                                            </div>

                                            <!-- Manual Course Entry -->
                                            <div id="editManualCourseSection{{ score.id }}" style="display: none;">
                                                <div class="mb-3">
                                                    <label class="form-label">Course Name</label>
                                                    <input type="text" class="form-control" id="editManualCourseName{{ score.id }}" placeholder="Enter course name">
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label class="form-label">Par</label>
                                                            <input type="number" class="form-control" id="editManualPar{{ score.id }}" value="72" min="60" max="80">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label class="form-label">Slope</label>
                                                            <input type="number" class="form-control" id="editManualSlopeRating{{ score.id }}" value="113" min="55" max="155">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Course Rating</label>
                                                    <input type="number" class="form-control" id="editManualCourseRating{{ score.id }}" step="0.1" min="50" max="80" placeholder="e.g. 72.3">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label">Gross Score</label>
                                                <input type="number" class="form-control" id="editGrossScore{{ score.id }}" value="{{ score.gross_score }}" min="40" max="150" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Date Played</label>
                                                <input type="date" class="form-control" id="editDatePlayed{{ score.id }}" value="{{ score.date_played.strftime('%Y-%m-%d') }}" required>
                                            </div>
                                        </div>
                                        <div class="col-md-5 d-flex align-items-end">
                                            <div class="d-flex gap-2 w-100 mb-3">
                                                <button type="submit" class="btn btn-success flex-fill">
                                                    <i class="bi bi-check"></i> Save
                                                </button>
                                                <button type="button" class="btn btn-secondary flex-fill" onclick="cancelEdit({{ score.id }})">
                                                    <i class="bi bi-x"></i> Cancel
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
                            <h5 class="text-muted mt-3">No Scores Yet</h5>
                            <p class="text-muted">Start by adding some scores to calculate a handicap.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Handicap Calculation Info -->
            {% if handicap_index is not none %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5><i class="bi bi-calculator"></i> Handicap Calculation Details</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        Based on 2024 USGA Rules: 
                        {% set score_count = scores|length %}
                        {% if score_count >= 20 %}
                            Average of best 8 scores from most recent 20 rounds.
                        {% elif score_count == 19 %}
                            Average of best 7 scores.
                        {% elif score_count >= 17 %}
                            Average of best 6 scores.
                        {% elif score_count >= 15 %}
                            Average of best 5 scores.
                        {% elif score_count >= 12 %}
                            Average of best 4 scores.
                        {% elif score_count >= 9 %}
                            Average of best 3 scores.
                        {% elif score_count >= 7 %}
                            Average of best 2 scores.
                        {% elif score_count == 6 %}
                            Average of best 2 scores with -1.0 adjustment.
                        {% elif score_count == 5 %}
                            Best single score with no adjustment.
                        {% elif score_count == 4 %}
                            Best single score with -1.0 adjustment.
                        {% elif score_count == 3 %}
                            Best single score with -2.0 adjustment.
                        {% endif %}
                    </p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let courses = [];
        const golferId = {{ golfer.id }};

        // Utility functions
        function showAlert(message, type = 'success') {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.body.insertAdjacentHTML('afterbegin', alertHtml);
            
            setTimeout(() => {
                const alert = document.querySelector('.alert');
                if (alert) alert.remove();
            }, 5000);
        }

        async function fetchData(url, options = {}) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Fetch error:', error);
                showAlert('Error communicating with server', 'danger');
                throw error;
            }
        }

        // Load courses for dropdowns
        async function loadCourses() {
            try {
                courses = await fetchData('/api/courses');
                updateCourseSelects();
            } catch (error) {
                console.error('Error loading courses:', error);
            }
        }

        function updateCourseSelects() {
            const selects = document.querySelectorAll('#newScoreCourse, .edit-course-select');
            selects.forEach(select => {
                select.innerHTML = '<option value="">Select Course</option>' +
                    courses.map(course => `<option value="${course.id}">${course.name}</option>`).join('');
            });
        }

        // New score form handling
        document.getElementById('newExistingCourse').addEventListener('change', () => {
            document.getElementById('newExistingCourseSection').style.display = 'block';
            document.getElementById('newManualCourseSection').style.display = 'none';
            document.getElementById('newScoreCourse').value = '';
        });

        document.getElementById('newManualCourse').addEventListener('change', () => {
            document.getElementById('newExistingCourseSection').style.display = 'none';
            document.getElementById('newManualCourseSection').style.display = 'block';
            document.getElementById('newManualCourseName').value = '';
            document.getElementById('newManualCourseRating').value = '';
        });

        document.getElementById('newScoreForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const grossScore = parseInt(document.getElementById('newGrossScore').value);
            const datePlayed = document.getElementById('newDatePlayed').value;
            const isManualEntry = document.getElementById('newManualCourse').checked;
            
            let requestData = {
                golfer_id: golferId,
                gross_score: grossScore,
                date_played: datePlayed
            };

            if (isManualEntry) {
                const courseName = document.getElementById('newManualCourseName').value;
                const par = parseInt(document.getElementById('newManualPar').value);
                const courseRating = parseFloat(document.getElementById('newManualCourseRating').value);
                const slopeRating = parseInt(document.getElementById('newManualSlopeRating').value);
                
                if (!courseName || !courseRating) {
                    showAlert('Please fill in course name and course rating', 'danger');
                    return;
                }
                
                requestData.manual_course = {
                    name: courseName,
                    par: par,
                    course_rating: courseRating,
                    slope_rating: slopeRating
                };
            } else {
                const courseId = document.getElementById('newScoreCourse').value;
                if (!courseId) {
                    showAlert('Please select a course', 'danger');
                    return;
                }
                requestData.course_id = parseInt(courseId);
            }

            try {
                await fetchData('/api/scores', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                showAlert('Score added successfully!');
                document.getElementById('newScoreForm').reset();
                document.getElementById('newExistingCourse').checked = true;
                document.getElementById('newExistingCourseSection').style.display = 'block';
                document.getElementById('newManualCourseSection').style.display = 'none';
                document.getElementById('newManualPar').value = '72';
                document.getElementById('newManualSlopeRating').value = '113';
                
                setTimeout(() => location.reload(), 1000);
            } catch (error) {
                showAlert('Error adding score', 'danger');
            }
        });

        // Edit score functionality
        function editScore(scoreId) {
            const scoreItem = document.getElementById(`score-${scoreId}`);
            const displayDiv = scoreItem.querySelector('.score-display');
            const editDiv = scoreItem.querySelector('.score-edit');
            
            displayDiv.style.display = 'none';
            editDiv.style.display = 'block';
            
            // Set up course method toggles for this edit form
            const existingRadio = document.getElementById(`editExistingCourse${scoreId}`);
            const manualRadio = document.getElementById(`editManualCourse${scoreId}`);
            
            existingRadio.addEventListener('change', () => {
                document.getElementById(`editExistingCourseSection${scoreId}`).style.display = 'block';
                document.getElementById(`editManualCourseSection${scoreId}`).style.display = 'none';
            });
            
            manualRadio.addEventListener('change', () => {
                document.getElementById(`editExistingCourseSection${scoreId}`).style.display = 'none';
                document.getElementById(`editManualCourseSection${scoreId}`).style.display = 'block';
            });
        }

        function cancelEdit(scoreId) {
            const scoreItem = document.getElementById(`score-${scoreId}`);
            const displayDiv = scoreItem.querySelector('.score-display');
            const editDiv = scoreItem.querySelector('.score-edit');
            
            displayDiv.style.display = 'block';
            editDiv.style.display = 'none';
        }

        // Handle edit form submissions
        document.addEventListener('submit', async (e) => {
            if (e.target.classList.contains('edit-score-form')) {
                e.preventDefault();
                
                const scoreId = e.target.dataset.scoreId;
                const grossScore = parseInt(document.getElementById(`editGrossScore${scoreId}`).value);
                const datePlayed = document.getElementById(`editDatePlayed${scoreId}`).value;
                const isManualEntry = document.getElementById(`editManualCourse${scoreId}`).checked;
                
                let requestData = {
                    gross_score: grossScore,
                    date_played: datePlayed
                };

                if (isManualEntry) {
                    const courseName = document.getElementById(`editManualCourseName${scoreId}`).value;
                    const par = parseInt(document.getElementById(`editManualPar${scoreId}`).value);
                    const courseRating = parseFloat(document.getElementById(`editManualCourseRating${scoreId}`).value);
                    const slopeRating = parseInt(document.getElementById(`editManualSlopeRating${scoreId}`).value);
                    
                    if (!courseName || !courseRating) {
                        showAlert('Please fill in course name and course rating', 'danger');
                        return;
                    }
                    
                    requestData.manual_course = {
                        name: courseName,
                        par: par,
                        course_rating: courseRating,
                        slope_rating: slopeRating
                    };
                } else {
                    const courseId = document.getElementById(`editScoreCourse${scoreId}`).value;
                    if (courseId) {
                        requestData.course_id = parseInt(courseId);
                    }
                }

                try {
                    await fetchData(`/api/scores/${scoreId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    });
                    
                    showAlert('Score updated successfully!');
                    setTimeout(() => location.reload(), 1000);
                } catch (error) {
                    showAlert('Error updating score', 'danger');
                }
            }
        });

        async function deleteScore(scoreId) {
            if (!confirm('Are you sure you want to delete this score?')) {
                return;
            }

            try {
                const response = await fetch(`/api/scores/${scoreId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('Score deleted successfully!');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showAlert('Error deleting score', 'danger');
                }
            } catch (error) {
                showAlert('Error deleting score', 'danger');
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            loadCourses();
            
            // Set today's date as default for new score
            document.getElementById('newDatePlayed').valueAsDate = new Date();
        });
    </script>
</body>
</html> 