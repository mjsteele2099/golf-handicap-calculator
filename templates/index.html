<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Handicap Calculator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px auto;
            padding: 30px;
            max-width: 1200px;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.2s ease;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        .nav-tabs .nav-link {
            border: none;
            border-radius: 10px;
            margin-right: 10px;
            color: #667eea;
            font-weight: 600;
        }
        .nav-tabs .nav-link.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .handicap-display {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            padding: 20px;
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            margin: 20px 0;
        }
        .score-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }
        .alert {
            border-radius: 10px;
            border: none;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <div class="text-center mb-4">
                <h1 class="display-4 text-primary mb-2">
                    <i class="bi bi-trophy"></i> Golf Handicap Calculator
                </h1>
                <p class="lead text-muted">Track scores and calculate handicaps for your golf group</p>
            </div>

            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="golfers-tab" data-bs-toggle="tab" data-bs-target="#golfers" type="button" role="tab">
                        <i class="bi bi-people"></i> Golfers
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="scores-tab" data-bs-toggle="tab" data-bs-target="#scores" type="button" role="tab">
                        <i class="bi bi-calculator"></i> Add Score
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="courses-tab" data-bs-toggle="tab" data-bs-target="#courses" type="button" role="tab">
                        <i class="bi bi-geo"></i> Courses
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="handicap-tab" data-bs-toggle="tab" data-bs-target="#handicap" type="button" role="tab">
                        <i class="bi bi-trophy"></i> Calculate Handicap
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="mainTabContent">
                
                <!-- Golfers Tab -->
                <div class="tab-pane fade show active" id="golfers" role="tabpanel">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="bi bi-person-plus"></i> Add New Golfer</h5>
                                </div>
                                <div class="card-body">
                                    <form id="golferForm">
                                        <div class="mb-3">
                                            <label class="form-label">Name</label>
                                            <input type="text" class="form-control" id="golferName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Email (optional)</label>
                                            <input type="email" class="form-control" id="golferEmail">
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="bi bi-plus-circle"></i> Add Golfer
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="bi bi-people"></i> Golfers List</h5>
                                </div>
                                <div class="card-body">
                                    <div id="golfersList"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Score Tab -->
                <div class="tab-pane fade" id="scores" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="bi bi-plus-circle"></i> Add New Score</h5>
                                </div>
                                <div class="card-body">
                                    <form id="scoreForm">
                                        <div class="mb-3">
                                            <label class="form-label">Golfer</label>
                                            <select class="form-control" id="scoreGolfer" required>
                                                <option value="">Select Golfer</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Course Entry Method Toggle -->
                                        <div class="mb-3">
                                            <label class="form-label">Course Entry Method</label>
                                            <div class="btn-group w-100" role="group">
                                                <input type="radio" class="btn-check" name="courseMethod" id="existingCourse" checked>
                                                <label class="btn btn-outline-primary" for="existingCourse">Select Existing Course</label>
                                                
                                                <input type="radio" class="btn-check" name="courseMethod" id="manualCourse">
                                                <label class="btn btn-outline-primary" for="manualCourse">Enter Course Details</label>
                                            </div>
                                        </div>

                                        <!-- Existing Course Selection -->
                                        <div id="existingCourseSection" class="mb-3">
                                            <label class="form-label">Course</label>
                                            <select class="form-control" id="scoreCourse">
                                                <option value="">Select Course</option>
                                            </select>
                                        </div>

                                        <!-- Manual Course Entry -->
                                        <div id="manualCourseSection" style="display: none;">
                                            <div class="mb-3">
                                                <label class="form-label">Course Name</label>
                                                <input type="text" class="form-control" id="manualCourseName" placeholder="Enter course name">
                                            </div>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <div class="mb-3">
                                                        <label class="form-label">Par</label>
                                                        <input type="number" class="form-control" id="manualPar" value="72" min="60" max="80">
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="mb-3">
                                                        <label class="form-label">Course Rating</label>
                                                        <input type="number" class="form-control" id="manualCourseRating" step="0.1" min="50" max="80" placeholder="e.g. 72.3">
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="mb-3">
                                                        <label class="form-label">Slope Rating</label>
                                                        <input type="number" class="form-control" id="manualSlopeRating" value="113" min="55" max="155">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Gross Score</label>
                                            <input type="number" class="form-control" id="grossScore" min="40" max="150" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Date Played</label>
                                            <input type="date" class="form-control" id="datePlayed" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="bi bi-save"></i> Add Score
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="bi bi-list"></i> Recent Scores</h5>
                                </div>
                                <div class="card-body">
                                    <div id="recentScores"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Courses Tab -->
                <div class="tab-pane fade" id="courses" role="tabpanel">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="bi bi-geo-alt-fill"></i> Add New Course</h5>
                                </div>
                                <div class="card-body">
                                    <form id="courseForm">
                                        <div class="mb-3">
                                            <label class="form-label">Course Name</label>
                                            <input type="text" class="form-control" id="courseName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Par</label>
                                            <input type="number" class="form-control" id="coursePar" value="72" min="60" max="80">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Course Rating</label>
                                            <input type="number" class="form-control" id="courseRating" step="0.1" min="50" max="80" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Slope Rating</label>
                                            <input type="number" class="form-control" id="slopeRating" value="113" min="55" max="155" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="bi bi-plus-circle"></i> Add Course
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="bi bi-list"></i> Courses</h5>
                                </div>
                                <div class="card-body">
                                    <div id="coursesList"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calculate Handicap Tab -->
                <div class="tab-pane fade" id="handicap" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="bi bi-calculator"></i> Calculate Course Handicap</h5>
                                </div>
                                <div class="card-body">
                                    <form id="handicapForm">
                                        <div class="mb-3">
                                            <label class="form-label">Golfer</label>
                                            <select class="form-control" id="handicapGolfer" required>
                                                <option value="">Select Golfer</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Course to Play</label>
                                            <select class="form-control" id="handicapCourse" required>
                                                <option value="">Select Course</option>
                                            </select>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="bi bi-trophy"></i> Calculate Handicap
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="bi bi-trophy"></i> Handicap Result</h5>
                                </div>
                                <div class="card-body">
                                    <div id="handicapResult"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



            <!-- Alert Container -->
            <div id="alertContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let golfers = [];
        let courses = [];

        // Utility functions
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            alertContainer.insertAdjacentHTML('beforeend', alertHtml);
            
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) alert.remove();
            }, 5000);
        }

        async function fetchData(url, options = {}) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Fetch error:', error);
                showAlert('Error communicating with server', 'danger');
                throw error;
            }
        }

        // Load data functions
        async function loadGolfers() {
            try {
                golfers = await fetchData('/api/golfers');
                updateGolfersList();
                updateGolferSelects();
            } catch (error) {
                console.error('Error loading golfers:', error);
            }
        }

        async function loadCourses() {
            try {
                courses = await fetchData('/api/courses');
                updateCoursesList();
                updateCourseSelects();
            } catch (error) {
                console.error('Error loading courses:', error);
            }
        }

        // Update UI functions
        function updateGolfersList() {
            const container = document.getElementById('golfersList');
            if (golfers.length === 0) {
                container.innerHTML = '<p class="text-muted">No golfers added yet.</p>';
                return;
            }

            container.innerHTML = golfers.map(golfer => `
                <div class="d-flex justify-content-between align-items-center p-3 mb-2 bg-light rounded">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            ${golfer.profile_picture ? 
                                `<img src="/static/profile_pics/${golfer.profile_picture}" alt="${golfer.name}" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">` : 
                                `<div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center" style="width: 50px; height: 50px; color: white; font-size: 20px;">${golfer.name.charAt(0).toUpperCase()}</div>`
                            }
                        </div>
                        <div>
                            <h6 class="mb-1">${golfer.name}</h6>
                            <small class="text-muted">
                                Handicap Index: ${golfer.handicap_index !== null ? golfer.handicap_index : 'Not enough scores'} | 
                                Scores: ${golfer.score_count}
                            </small>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary btn-sm" onclick="uploadProfilePicture(${golfer.id})">
                            <i class="bi bi-camera"></i> Photo
                        </button>
                        <a href="/golfer/${golfer.id}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-eye"></i> View Details
                        </a>
                    </div>
                </div>
            `).join('');
        }

        function updateCoursesList() {
            const container = document.getElementById('coursesList');
            if (courses.length === 0) {
                container.innerHTML = '<p class="text-muted">No courses added yet.</p>';
                return;
            }

            container.innerHTML = courses.map(course => `
                <div class="p-3 mb-2 bg-light rounded">
                    <h6 class="mb-1">${course.name}</h6>
                    <small class="text-muted">
                        Par: ${course.par} | Rating: ${course.course_rating} | Slope: ${course.slope_rating}
                    </small>
                </div>
            `).join('');
        }

        function updateGolferSelects() {
            const selects = ['scoreGolfer', 'handicapGolfer'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Select Golfer</option>' +
                    golfers.map(golfer => `<option value="${golfer.id}">${golfer.name}</option>`).join('');
            });
        }

        function updateCourseSelects() {
            const selects = ['scoreCourse', 'handicapCourse'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Select Course</option>' +
                    courses.map(course => `<option value="${course.id}">${course.name}</option>`).join('');
            });
        }

        // Event handlers
        document.getElementById('golferForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('golferName').value;
            const email = document.getElementById('golferEmail').value;

            try {
                await fetchData('/api/golfers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email })
                });
                
                showAlert('Golfer added successfully!');
                document.getElementById('golferForm').reset();
                loadGolfers();
            } catch (error) {
                showAlert('Error adding golfer', 'danger');
            }
        });

        document.getElementById('courseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('courseName').value;
            const par = parseInt(document.getElementById('coursePar').value);
            const courseRating = parseFloat(document.getElementById('courseRating').value);
            const slopeRating = parseInt(document.getElementById('slopeRating').value);

            try {
                await fetchData('/api/courses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, par, course_rating: courseRating, slope_rating: slopeRating })
                });
                
                showAlert('Course added successfully!');
                document.getElementById('courseForm').reset();
                loadCourses();
            } catch (error) {
                showAlert('Error adding course', 'danger');
            }
        });

        // Course entry method toggle
        document.getElementById('existingCourse').addEventListener('change', () => {
            document.getElementById('existingCourseSection').style.display = 'block';
            document.getElementById('manualCourseSection').style.display = 'none';
            // Clear manual entry fields
            document.getElementById('manualCourseName').value = '';
            document.getElementById('manualCourseRating').value = '';
        });

        document.getElementById('manualCourse').addEventListener('change', () => {
            document.getElementById('existingCourseSection').style.display = 'none';
            document.getElementById('manualCourseSection').style.display = 'block';
            // Clear course selection
            document.getElementById('scoreCourse').value = '';
        });

        document.getElementById('scoreForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const golferId = document.getElementById('scoreGolfer').value;
            const grossScore = parseInt(document.getElementById('grossScore').value);
            const datePlayed = document.getElementById('datePlayed').value;
            
            // Check which course entry method is selected
            const isManualEntry = document.getElementById('manualCourse').checked;
            
            let requestData = {
                golfer_id: parseInt(golferId),
                gross_score: grossScore,
                date_played: datePlayed
            };

            if (isManualEntry) {
                // Manual course entry
                const courseName = document.getElementById('manualCourseName').value;
                const par = parseInt(document.getElementById('manualPar').value);
                const courseRating = parseFloat(document.getElementById('manualCourseRating').value);
                const slopeRating = parseInt(document.getElementById('manualSlopeRating').value);
                
                if (!courseName || !courseRating) {
                    showAlert('Please fill in course name and course rating', 'danger');
                    return;
                }
                
                requestData.manual_course = {
                    name: courseName,
                    par: par,
                    course_rating: courseRating,
                    slope_rating: slopeRating
                };
            } else {
                // Existing course selection
                const courseId = document.getElementById('scoreCourse').value;
                if (!courseId) {
                    showAlert('Please select a course', 'danger');
                    return;
                }
                requestData.course_id = parseInt(courseId);
            }

            try {
                await fetchData('/api/scores', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                showAlert('Score added successfully!');
                document.getElementById('scoreForm').reset();
                // Reset to existing course method
                document.getElementById('existingCourse').checked = true;
                document.getElementById('existingCourseSection').style.display = 'block';
                document.getElementById('manualCourseSection').style.display = 'none';
                // Reset manual fields to defaults
                document.getElementById('manualPar').value = '72';
                document.getElementById('manualSlopeRating').value = '113';
                loadGolfers(); // Refresh to update handicaps
                loadCourses(); // Refresh courses list in case a new one was added
            } catch (error) {
                showAlert('Error adding score', 'danger');
            }
        });

        document.getElementById('handicapForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const golferId = document.getElementById('handicapGolfer').value;
            const courseId = document.getElementById('handicapCourse').value;

            try {
                const result = await fetchData(`/api/handicap/${golferId}/${courseId}`);
                
                const resultContainer = document.getElementById('handicapResult');
                if (result.handicap_index === null) {
                    resultContainer.innerHTML = `
                        <div class="alert alert-warning">
                            <strong>${result.golfer_name}</strong> needs at least 5 scores to calculate a handicap.
                        </div>
                    `;
                } else {
                    resultContainer.innerHTML = `
                        <div class="text-center">
                            <h6>${result.golfer_name}</h6>
                            <p class="text-muted">Playing at ${result.course_name}</p>
                            <div class="handicap-display">
                                ${result.course_handicap}
                            </div>
                            <small class="text-muted">
                                Handicap Index: ${result.handicap_index}<br>
                                Course Handicap: ${result.course_handicap}
                            </small>
                        </div>
                    `;
                }
            } catch (error) {
                showAlert('Error calculating handicap', 'danger');
            }
        });

        // Profile picture upload function
        function uploadProfilePicture(golferId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('profile_picture', file);

                try {
                    const response = await fetch(`/api/golfers/${golferId}/profile-picture`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const result = await response.json();
                    showAlert('Profile picture uploaded successfully!');
                    loadGolfers(); // Refresh the golfers list
                } catch (error) {
                    console.error('Upload error:', error);
                    showAlert('Error uploading profile picture', 'danger');
                }
            };
            input.click();
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            loadGolfers();
            loadCourses();
            
            // Set today's date as default
            document.getElementById('datePlayed').valueAsDate = new Date();
        });
    </script>
</body>
</html> 